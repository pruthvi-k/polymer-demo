
<!--<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">-->
<link rel="import" href="behaviours/graphBehaviour.html">

<dom-module id="graph-view">
    <script src="http://code.highcharts.com/adapters/standalone-framework.js"></script>
    <script src="http://code.highcharts.com/highcharts.js"></script>

    <template>
       
        <h4 id="gtitle" align="center">{{graphTitle}}        </h4>
        
            <div id="chartContainer"></div>
        
    </template>

    <script>
var chart;
var seriesData;
Polymer({
    is: 'graph-view',
    properties: {
        seriesData: {type: Object, notify: true},
        showGraph: {type: Boolean, value: false},
        graphTitle: {type: String, notify: true, observer: '_setGraphTitle', value: 'Vertical Grouped Chart'},
        type: {type: String, notify: true, observer: '_setGraphType'},
        timespan:{type: Number, notify: true, observer: '_filterData'},
        filterType: {type: String}
    },
    ready: function () {
//        var options = options || new Object();
//
//        options.chart = options.chart || new Object();
//        options.chart.renderTo = 'chartContainer';
//        options.chart.type = 'bar';
//
//        options.series = new Array();
//        options.series[0] = new Object();
//        options.series[0].name = 'Jane';
//        options.series[0].data = new Array(1, 0, 4);

        //var chart = new Highcharts.Chart(options);
    },
    _filterData: function(value) {
       
        var series = this.seriesData || this.getSeriesData();
        var today = new Date();
        var start = new Date(today.setDate(today.getDate() - today.getDay()-value));
        range = Date.UTC(start.getFullYear(), start.getMonth(), start.getDay());
      // console.log('befor echange final series data', this.getSeriesData());
        series = this._mapData(series, range);
        
    },
    attached: function () {
        this.showGraph = true;
        this.renderChart();
    },
    _setGraphTitle: function (value) {
        console.log('graph title changes', value);
    },
    _setGraphType: function (value) {
        this._changeType(this.chart, value.toLowerCase());
    },
    _changeType: function (chart, newType)
    {
        var noS = chart.series.length;       
        for (var i = 0; i <= noS; i++)
        {
            if (chart.series[i])
            {
                chart.series[i].update({
                    type: newType
                });
            }
        }
    },
    renderChart: function () {
        if (this.showGraph) {
            this.chart = new Highcharts.Chart({
                chart: {
                    renderTo: 'chartContainer',
                    type: 'column'
                },
                title: {
                    text: 'Vertical Grouped Chart'
                },
                yAxis: {
                    title: {
                        text: ''
                    }
                },
                xAxis: {
                    type: 'datetime',
                    dateTimeLabelFormats: {// don't display the dummy year
                        month: '%e. %b',
                        year: '%b'
                    },
                    title: {
                        text: ''
                    }
                },
                series: this.getSeriesData()
            });
        }
    },
    _checkRange: function(data) {   
        //if time of data satisfies given range
        if(data[0] > this.range){            
            return true;
        }                    
    },
    _mapData: function(series, range) {
        
        for (seriesRow = 0; seriesLength = series.length, seriesRow < seriesLength; seriesRow++) {          
           var dataLength = series[seriesRow].data.length
           mydata = series[seriesRow].data;
           var data = mydata.filter(this._checkRange, {range: range});
           
//           if(this.chart.series[seriesRow])
           this.chart.series[seriesRow].setData(data, true);//.update({
//                    data: series[seriesRow].data
//                });
           
        } 
       //this.chart.redraw(); 
      //  return series;
    },
    getSeriesData: function () {
        return [{
                name: 'Open',
                data: [
                    [Date.UTC(2016, 9, 9), 0.30],
                    [Date.UTC(2016, 9, 4), 0.28],
                    [Date.UTC(2016, 8, 19), 0.25],
                    [Date.UTC(2016, 8, 11), 0.79],
                    [Date.UTC(2016, 7, 26), 0.72],
                    [Date.UTC(2016, 7, 3), 1.02],
                    [Date.UTC(2016, 7, 11), 1.12],
                ],
                pointWidth: 20
            }, {
                name: 'Awaiting',
                data: [
                    [Date.UTC(2016, 9, 10), 0.47],
                    [Date.UTC(2016, 9, 9), 0.70],
                    [Date.UTC(2016, 8, 25), 0.71],
                    [Date.UTC(2016, 8, 2), 4.02],
                    [Date.UTC(2016, 7, 10), 2.12],
                    [Date.UTC(2016, 6, 20), 1.30],
                    [Date.UTC(2016, 6, 3), 1.28],
                    [Date.UTC(2016, 5, 8), 1.25],
                ],
                pointWidth: 20
            }, {
                name: 'Close',
                data: [
                    [Date.UTC(2016, 10, 9), 1.47],
                    [Date.UTC(2016, 10, 5), 2.79],
                    [Date.UTC(2016, 9, 26), 3.72],
                    [Date.UTC(2016, 9, 3), 1.02],
                    [Date.UTC(2016, 8, 11), 5.12],
                    [Date.UTC(2016, 8, 3), 4.02],
                    [Date.UTC(2016, 7, 11), 7.12],
                    [Date.UTC(2016, 6, 21), 2.30],
                ],
                pointWidth: 20
            }];
    }
    // behaviors: [GraphBehaviour.RenderBehaviour],	 
    /*ready: function() {
     this.addEventListener('updateGraphConfig', this._shouldUpdateGraphConfig);
     },
     
     _shouldUpdateGraphConfig: function(event) {
     console.log('event from graph view', event.detail);
     this.config = event.detail.config;
     }*/
});
    </script>
</dom-module>
